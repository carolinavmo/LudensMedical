{% extends 'admin/course_wizard.html' %}

{% block head %}
{{ super() }}
<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block wizard_content %}
<div class="px-4 py-5 sm:p-6">
    <div class="grid grid-cols-6 gap-6">
        <div class="col-span-6">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-semibold text-gray-900">Course Modules</h2>
                <a href="{{ url_for('admin_module_new', course_id=course.id) }}" class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add New Module
                </a>
            </div>
            
            <p class="text-sm text-gray-500 mb-6">
                Modules are the building blocks of your course. Each module can contain text content, videos, and PDFs.
                You should add at least one module to your course before proceeding to the next step.
            </p>
            
            {% if modules %}
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <ul class="divide-y divide-gray-200" id="module-list"
                        data-reorder-url="{{ url_for('admin_modules_reorder', course_id=course.id) }}">
                        {% for module in modules %}
                        <li class="module-item" data-module-id="{{ module.id }}">
                            <div class="px-4 py-4 sm:px-6 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0 cursor-move">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-primary-600 truncate">
                                            {{ module.order }}. {{ module.title }}
                                        </p>
                                        <div class="mt-1 flex items-center space-x-2">
                                            {% if module.video_url or module.video_file %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                    <svg class="mr-1 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                                                    </svg>
                                                    Video
                                                </span>
                                            {% endif %}
                                            {% if module.pdf_url or module.pdf_file %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                                    <svg class="mr-1 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                                    </svg>
                                                    PDF
                                                </span>
                                            {% endif %}
                                            
                                            <!-- Check if there's a quiz for this module -->
                                            {% set has_quiz = false %}
                                            {% for quiz in quizzes %}
                                                {% if quiz.module_id == module.id %}
                                                    {% set has_quiz = true %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if has_quiz %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                                    <svg class="mr-1 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                                                    </svg>
                                                    Quiz
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button 
                                        data-module-edit
                                        data-module-id="{{ module.id }}"
                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                                    >
                                        Edit Content
                                    </button>
                                    
                                    {% set module_quiz = None %}
                                    {% for quiz in quizzes %}
                                        {% if quiz.module_id == module.id %}
                                            {% set module_quiz = quiz %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if module_quiz %}
                                        <a href="{{ url_for('admin_quiz_edit', quiz_id=module_quiz.id) }}" class="inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-xs font-medium rounded-md text-primary-700 bg-primary-100 hover:bg-primary-200">
                                            Edit Quiz
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('admin_quiz_new', module_id=module.id) }}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                            Add Quiz
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Reordering Modules Message -->
                <div class="mt-2 text-sm text-gray-500">
                    <p>Drag and drop modules to reorder them.</p>
                </div>
            {% else %}
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No modules</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new module.</p>
                    <div class="mt-6">
                        <a href="{{ url_for('admin_module_new', course_id=course.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            New Module
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Navigation Buttons -->
<div class="px-4 py-3 bg-gray-50 text-right sm:px-6 flex justify-between">
    <a href="{{ url_for('admin_course_wizard_step1', course_id=course.id) }}" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        Back: Course Details
    </a>
    
    <form action="{{ url_for('admin_course_wizard_step2_next', course_id=course.id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <button type="submit" {% if not modules %}disabled{% endif %} class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md {% if modules %}text-white bg-primary-600 hover:bg-primary-700{% else %}text-gray-400 bg-gray-200 cursor-not-allowed{% endif %} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            Next: Add Quizzes
        </button>
    </form>
</div>
{% endblock %}

<!-- Modal Templates -->
{% for module in modules %}
<!-- Module Edit Modal for {{ module.id }} -->
<div id="modal-module-{{ module.id }}" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 transition-opacity">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        
        <!-- Modal -->
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-4xl sm:w-full">
            <!-- Modal Header -->
            <div class="bg-gray-100 px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Edit Module: {{ module.title }}
                </h3>
                <button onclick="document.getElementById('modal-module-{{ module.id }}').classList.add('hidden')" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Tab Container -->
            <div class="px-4 py-5 sm:p-6 max-h-[calc(100vh-200px)] overflow-y-auto">
                <form action="{{ url_for('admin_module_edit', module_id=module.id) }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <!-- Content -->
                    <div>
                        <div class="mb-4">
                            <label for="title-{{ module.id }}" class="block text-sm font-medium text-gray-700">Module Title</label>
                            <input 
                                type="text" 
                                id="title-{{ module.id }}" 
                                name="title" 
                                value="{{ module.title }}"
                                class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            >
                        </div>
                        
                        <div class="mb-4">
                            <label for="content-{{ module.id }}" class="block text-sm font-medium text-gray-700">Content</label>
                            <textarea 
                                id="content-{{ module.id }}" 
                                name="content" 
                                rows="10"
                                class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            >{{ module.content }}</textarea>
                        </div>
                    
                        <div class="mb-4">
                            <label for="video_url-{{ module.id }}" class="block text-sm font-medium text-gray-700">Video URL (External)</label>
                            <input 
                                type="text" 
                                id="video_url-{{ module.id }}" 
                                name="video_url" 
                                value="{{ module.video_url or '' }}"
                                class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            >
                            <p class="mt-1 text-sm text-gray-500">Enter a URL for an external video (YouTube, Vimeo, etc.)</p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="order-{{ module.id }}" class="block text-sm font-medium text-gray-700">Module Order</label>
                            <input 
                                type="number" 
                                id="order-{{ module.id }}" 
                                name="order" 
                                value="{{ module.order }}"
                                min="1"
                                class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"
                            >
                            <p class="mt-1 text-sm text-gray-500">Order in which this module appears in the course</p>
                        </div>
                    </div>
                    
                    <!-- Footer with save button -->
                    <div class="flex justify-end mt-8 pt-5 border-t border-gray-200">
                        <button 
                            type="button" 
                            onclick="document.getElementById('modal-module-{{ module.id }}').classList.add('hidden')" 
                            class="mr-3 bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                        >
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/module-reorder.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButtons = document.querySelectorAll('[data-module-edit]');
        editButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const moduleId = this.getAttribute('data-module-id');
                // Show the modal using DOM manipulation
                const modal = document.getElementById('modal-module-' + moduleId);
                if (modal) {
                    modal.classList.remove('hidden');
                }
            });
        });
    });
</script>
{% endblock %}